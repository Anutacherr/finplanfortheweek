<script>
    // Установка дат текущей недели
    function setCurrentWeekDates() {
        const now = new Date();
        const dayOfWeek = now.getDay(); // 0 (воскресенье) до 6 (суббота)
        const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        const monday = new Date(now);
        monday.setDate(now.getDate() + diffToMonday);
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);

        const formatDate = (date) => {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${day}.${month}`;
        };

        document.getElementById('dateRange').value = `${formatDate(monday)} - ${formatDate(sunday)}`;
    }

    // Автовысота textarea
    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    // Настройка авторазмеров для всех textarea
    function setupAutoResize() {
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            autoResizeTextarea(textarea);
            textarea.addEventListener('input', () => autoResizeTextarea(textarea));
        });
    }

    // Сохранение данных
    function saveAllData() {
        document.querySelectorAll('[id]').forEach(el => {
            const value = el.type === 'checkbox' ? el.checked : el.value;
            localStorage.setItem(el.id, value);
        });
    }

    // Очистка данных
    function clearAllData() {
        if (confirm('Вы уверены, что хотите очистить все данные? Это действие нельзя отменить.')) {
            const elements = [
                'dateRange', 'intention', 'reward', 'successes', 'improvements',
                'habit1', 'habit2', 'habit3',
                'goal1', 'goal1-step1', 'goal1-step2', 'goal1-step3',
                'goal2', 'goal2-step1', 'goal2-step2', 'goal2-step3',
                'goal3', 'goal3-step1', 'goal3-step2', 'goal3-step3',
                'habit1-mon', 'habit1-tue', 'habit1-wed', 'habit1-thu', 'habit1-fri', 'habit1-sat', 'habit1-sun',
                'habit2-mon', 'habit2-tue', 'habit2-wed', 'habit2-thu', 'habit2-fri', 'habit2-sat', 'habit2-sun',
                'habit3-mon', 'habit3-tue', 'habit3-wed', 'habit3-thu', 'habit3-fri', 'habit3-sat', 'habit3-sun'
            ];

            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = false;
                    } else {
                        element.value = '';
                    }
                    localStorage.removeItem(id);
                }
            });

            // Сброс даты на текущую неделю
            setCurrentWeekDates();
        }
    }

    // Загрузка сохранённых данных
    function loadSavedData() {
        const elements = [
            'dateRange', 'intention', 'reward', 'successes', 'improvements',
            'habit1', 'habit2', 'habit3',
            'goal1', 'goal1-step1', 'goal1-step2', 'goal1-step3',
            'goal2', 'goal2-step1', 'goal2-step2', 'goal2-step3',
            'goal3', 'goal3-step1', 'goal3-step2', 'goal3-step3',
            'habit1-mon', 'habit1-tue', 'habit1-wed', 'habit1-thu', 'habit1-fri', 'habit1-sat', 'habit1-sun',
            'habit2-mon', 'habit2-tue', 'habit2-wed', 'habit2-thu', 'habit2-fri', 'habit2-sat', 'habit2-sun',
            'habit3-mon', 'habit3-tue', 'habit3-wed', 'habit3-thu', 'habit3-fri', 'habit3-sat', 'habit3-sun'
        ];

        elements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                const savedValue = localStorage.getItem(id);
                if (savedValue !== null) {
                    if (element.type === 'checkbox') {
                        element.checked = savedValue === 'true';
                    } else {
                        element.value = savedValue;
                        autoResizeTextarea(element);
                    }
                }
            }
        });

        // Если дата не сохранена — установим текущую
        if (!localStorage.getItem('dateRange')) {
            setCurrentWeekDates();
        }
    }

    // Экспорт в PDF
    async function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });

        const pages = [document.getElementById('page1'), document.getElementById('page2')];

        for (const page of pages) {
            await html2canvas(page, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                if (page.id !== 'page2') doc.addPage();
            });
        }

        doc.save('Финансовый_план_на_неделю.pdf');
    }

    // Экспорт в PNG
    async function exportToPNG() {
        const buttons = document.querySelector('.action-buttons');
        const originalDisplay = buttons.style.display;
        buttons.style.display = 'none';

        const pages = [document.getElementById('page1'), document.getElementById('page2')];
        for (const page of pages) {
            await html2canvas(page, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${page.id}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        buttons.style.display = originalDisplay;
    }

    // Инициализация
    document.addEventListener('DOMContentLoaded', () => {
        setCurrentWeekDates();
        loadSavedData();
        setupAutoResize();

        // Сохранение при изменении
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', saveAllData);
        });

        document.querySelectorAll('textarea, input[type="text"]').forEach(input => {
            input.addEventListener('input', saveAllData);
        });

        // Кнопки действий
        document.getElementById('saveData').addEventListener('click', saveAllData);
        document.getElementById('clearData').addEventListener('click', clearAllData);
        document.getElementById('printData').addEventListener('click', () => window.print());
        document.getElementById('exportPDF').addEventListener('click', exportToPDF);
        document.getElementById('exportPNG').addEventListener('click', exportToPNG);

        // Улучшение мобильного UX
        if ('ontouchstart' in window) {
            document.querySelectorAll('.day-wrapper').forEach(wrapper => {
                wrapper.style.padding = '5px';
            });
            document.querySelectorAll('input, textarea').forEach(el => {
                el.style.fontSize = '16px';
            });
        }
    });
</script>
